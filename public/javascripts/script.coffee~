validerTel = (tel) ->
  patron = /^[0-9]{3}\s+[0-9]{3}-[0-9]{4}$/
  vExpression = new RegExp(patron)
  if vExpression.test(tel.value)
    surligne tel, false
    true
  else
    alert "Saisissez le numero avec ce format: XXX XXX-XXXX"
    surligne tel, true
    false
validerDate = (date) ->
  patron = /^[0-9]{4}-[0-9]{2}-[0-9]{2}$/
  vExpression = new RegExp(patron)
  if vExpression.test(date.value)
    surligne date, false
    true
  else
    alert "Saisissez la date avec ce format: yyyy-mm-dd"
    surligne date, true
    false
sendSex = (sexe) ->
  if sexe.value is "M"
    sexe.value = 1
  else sexe.value = 2  if sexe.value is "F"
surligne = (champ, erreur) ->
  if erreur
    champ.style.backgroundColor = "#fba"
  else
    champ.style.backgroundColor = ""
verifChamp = (champ) ->
  if not (champ.value) or (champ.value.length < 2)
    alert "Le champ en surbrillance doit contenir au moins 2 carateres "
    surligne champ, true
    false
  else
    surligne champ, false
    true
verifModifChamp = ->
  nom = document.getElementById("nom")
  return false  unless verifChamp(nom)
  prenom = document.getElementById("prenom")
  return false  unless verifChamp(prenom)
  titre = document.getElementById("titre")
  return false  unless verifChamp(titre)
  text = document.getElementById("desc")
  unless verifChamp(text)
    false
  else
    save()
verifSaveChamp = ->
  nom = document.getElementById("nom")
  return false  unless verifChamp(nom)
  prenom = document.getElementById("prenom")
  return false  unless verifChamp(prenom)
  titre = document.getElementById("titre")
  return false  unless verifChamp(titre)
  text = document.getElementById("desc")
  unless verifChamp(text)
    false
  else
    enregistrer()

#*******save_ajax_jacques********/
save = ->
  objectToSave = buildObject()
  saveToServer objectToSave, displayResult
enregistrer = ->
  objectToSave = buildObject()
  registerToServer objectToSave, displayResult
registerToServer = (objectToSave, callback) ->
  xhr = new XMLHttpRequest()
  xhr.open "POST", "/enregistrer", true
  jsonData = JSON.stringify(objectToSave)
  xhr.setRequestHeader "Content-type", "application/json"
  xhr.send jsonData
  xhr.onreadystatechange = ->
    if xhr.readyState is 4 and xhr.status isnt 500
      ent = parseInt(xhr.responseText)
      window.location.replace "/" + ent
buildObject = ->
  result = {}
  desc = []
  if document.getElementById("numero")
    result.id = document.getElementById("numero").value
    console.log "voici le numero: " + result.numero
  else
    result.id = 0
  result.nom = document.getElementById("nom").value
  console.log "voici le nom: " + result.nom
  result.prenom = document.getElementById("prenom").value
  console.log "voici le prenom: " + result.prenom
  if document.getElementById("date")
    result.date = document.getElementById("date").value
  else
    date = new Date()
    mois = date.getMonth() + 1
    jour = date.getDate()
    mois = "0" + mois  if mois < 10
    jour = "0" + jour  if jour < 10
    result.date = date.getFullYear() + "-" + mois + "-" + jour
  result.catego = document.getElementById("categorie").value
  result.titre = document.getElementById("titre").value
  temp = document.getElementById("desc").value
  temp.trim()
  para = ""
  tail = temp.length
  premier = 0
  second = 0
  para = "<p>" + temp + "</p>"
  para = para.replace(/\n\n/g, "</p><p>")
  para = para.replace(/\n/g, "<br/>")
  result.desc = para
  console.log result
  result
displayResult = (savedObject) ->
  console.log "Document sauvegardÃ© : " + JSON.stringify(savedObject)
saveToServer = (objectToSave, callback) ->
  xhr = new XMLHttpRequest()
  console.log "dans save"
  xhr.open "PUT", "/sauvegarde", true
  jsonData = JSON.stringify(objectToSave)
  xhr.setRequestHeader "Content-type", "application/json"
  xhr.send jsonData
  xhr.onreadystatechange = ->
    if xhr.readyState is 4 and xhr.status isnt 500
      ent = parseInt(xhr.responseText)
      window.location.replace "/" + ent
